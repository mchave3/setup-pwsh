name: Test Action

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-latest:
    name: Test Latest - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PowerShell (latest)
        id: setup-pwsh
        uses: ./
        with:
          version: 'latest'
          github-token: ${{ github.token }}

      - name: Verify installation
        shell: pwsh
        run: |
          Write-Host "‚úÖ PowerShell Version: $($PSVersionTable.PSVersion)"
          Write-Host "‚úÖ OS: $($PSVersionTable.OS)"
          Write-Host "‚úÖ Platform: $($PSVersionTable.Platform)"

          # Verify outputs
          Write-Host "‚úÖ Installed version output: ${{ steps.setup-pwsh.outputs.version }}"
          Write-Host "‚úÖ Installation path output: ${{ steps.setup-pwsh.outputs.path }}"

  test-stable-lts:
    name: Test Stable/LTS - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PowerShell (stable/lts)
        id: setup-pwsh
        uses: ./
        with:
          version: 'stable'
          github-token: ${{ github.token }}

      - name: Verify installation is 7.4.x
        shell: pwsh
        run: |
          $version = $PSVersionTable.PSVersion
          Write-Host "‚úÖ PowerShell LTS Version: $version"

          if ($version.Major -ne 7 -or $version.Minor -ne 4) {
            throw "Expected 7.4.x LTS version but got $version"
          }

          Write-Host "‚úÖ Confirmed LTS version 7.4.x"

  test-preview:
    name: Test Preview - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PowerShell (preview)
        id: setup-pwsh
        uses: ./
        with:
          version: 'preview'
          github-token: ${{ github.token }}

      - name: Verify installation
        shell: pwsh
        run: |
          Write-Host "‚úÖ PowerShell Preview Version: $($PSVersionTable.PSVersion)"
          Write-Host "‚úÖ Installed version output: ${{ steps.setup-pwsh.outputs.version }}"

  test-specific-version:
    name: Test Specific Version - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        version: ['7.4.13', '7.5.4']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PowerShell ${{ matrix.version }}
        id: setup-pwsh
        uses: ./
        with:
          version: ${{ matrix.version }}
          github-token: ${{ github.token }}

      - name: Verify installation
        shell: pwsh
        run: |
          $expectedVersion = "${{ matrix.version }}"
          $installedVersion = $PSVersionTable.PSVersion.ToString()

          Write-Host "Expected: $expectedVersion"
          Write-Host "Installed: $installedVersion"

          if ($installedVersion -notlike "$expectedVersion*") {
            throw "Version mismatch! Expected $expectedVersion but got $installedVersion"
          }

          Write-Host "‚úÖ Version verified successfully!"

  test-architecture:
    name: Test Architecture - ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
          - os: windows-latest
            arch: x64
          - os: windows-latest
            arch: x86
          - os: macos-latest
            arch: arm64
          - os: macos-15-intel
            arch: x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PowerShell (${{ matrix.arch }})
        id: setup-pwsh
        uses: ./
        with:
          version: 'stable'
          architecture: ${{ matrix.arch }}
          github-token: ${{ github.token }}

      - name: Verify installation
        shell: pwsh
        run: |
          Write-Host "‚úÖ PowerShell Version: $($PSVersionTable.PSVersion)"
          Write-Host "‚úÖ Architecture test passed for ${{ matrix.arch }}"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [test-latest, test-stable-lts, test-preview, test-specific-version, test-architecture]

    steps:
      - name: Generate Summary Table
        shell: pwsh
        run: |
          function Get-StatusEmoji {
            param([string]$Status)
            switch ($Status) {
              'success'   { '‚úÖ Passed' }
              'failure'   { '‚ùå Failed' }
              'cancelled' { '‚ö™ Cancelled' }
              'skipped'   { '‚è≠Ô∏è Skipped' }
              default     { '‚ùì Unknown' }
            }
          }

          $summary = @"
          ## üß™ Setup-Pwsh Test Results

          | Test | Status |
          |------|--------|
          | Latest Version | $(Get-StatusEmoji '${{ needs.test-latest.result }}') |
          | Stable/LTS Version | $(Get-StatusEmoji '${{ needs.test-stable-lts.result }}') |
          | Preview Version | $(Get-StatusEmoji '${{ needs.test-preview.result }}') |
          | Specific Versions | $(Get-StatusEmoji '${{ needs.test-specific-version.result }}') |
          | Architecture Tests | $(Get-StatusEmoji '${{ needs.test-architecture.result }}') |

          ### üìã Details

          - **Workflow:** ``${{ github.workflow }}``
          - **Run ID:** ``${{ github.run_id }}``
          - **Triggered by:** ``${{ github.event_name }}``
          - **Branch:** ``${{ github.ref_name }}``
          - **Commit:** ``${{ github.sha }}``
          "@

          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
